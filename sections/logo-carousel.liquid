{% comment %}
  Logo Carousel Section
  - No external libraries. Uses CSS scroll-snap + a tiny JS controller.
  - Features:
    * Auto scroll on/off + speed
    * Logos visible per view (desktop/tablet/mobile)
    * Global link target (same/new tab)
    * Per-logo optional title (above/below)
    * Section spacing (top/bottom)
    * Background color
    * Accessible controls & pause-on-hover
{% endcomment %}

<section
  id="logo-carousel-{{ section.id }}"
  class="logo-carousel-section"
  style="
    --bg: {{ section.settings.bg_color }};
    --pt: {{ section.settings.space_top }}px;
    --pb: {{ section.settings.space_bottom }}px;
    --gap: 16px;
    --per-desktop: {{ section.settings.per_desktop }};
    --per-tablet: {{ section.settings.per_tablet }};
    --per-mobile: {{ section.settings.per_mobile }};
    --auto-interval: {{ section.settings.auto_interval }};
    --dot-color: {{ section.settings.dot_color }};
    --dot-active-color: {{ section.settings.dot_active_color }};
  "
>
  <div class="logo-carousel-container">
    {% if section.settings.heading != blank %}
      <h2 class="logo-carousel-heading">{{ section.settings.heading | escape }}</h2>
    {% endif %}

    <div class="logo-carousel-track-wrap" data-section-id="{{ section.id }}">
      <button class="nav-btn prev" aria-label="Previous" type="button">
        <span aria-hidden="true">‹</span>
      </button>

      <div
        class="logo-carousel-track"
        role="region"
        aria-roledescription="carousel"
        aria-label="{{ section.settings.heading | default: 'Brand logos' | escape }}"
        tabindex="0"
        data-autoplay="{{ section.settings.autoplay }}"
        data-loop="true"
      >
        {% for block in section.blocks %}
          {% assign img = block.settings.logo %}
          {% if img != blank %}
            {%- capture item_title -%}{{ block.settings.logo_title | strip }}{%- endcapture -%}
            {% assign link = block.settings.link %}
            {% assign title_pos = block.settings.title_position %}
            <div class="logo-item" role="group" aria-roledescription="slide" aria-label="Logo {{ forloop.index }} of {{ section.blocks.size }}">
            {% if section.settings.show_titles and item_title != blank and title_pos == 'above' %}
            <div class="logo-title">{{ item_title }}</div>
            {% endif %}

              {% if link != blank %}
                <a
                  class="logo-link"
                  href="{{ link }}"
                  {% if section.settings.link_target == 'new' %}target="_blank" rel="noopener noreferrer"{% endif %}
                  aria-label="{{ item_title | default: 'Logo link' | escape }}"
                >
                  <img
                    class="logo-img"
                    src="{{ img | image_url: width: 600 }}"
                    srcset="
                      {{ img | image_url: width: 200 }} 200w,
                      {{ img | image_url: width: 300 }} 300w,
                      {{ img | image_url: width: 600 }} 600w
                    "
                    sizes="(min-width: 990px) calc((100vw - 2*var(--page-padding)) / var(--per-desktop)),
                           (min-width: 750px) calc((100vw - 2*var(--page-padding)) / var(--per-tablet)),
                           calc((100vw - 2*var(--page-padding)) / var(--per-mobile))"
                    alt="{{ block.settings.alt_text | default: img.alt | escape }}"
                    loading="lazy"
                  />
                </a>
              {% else %}
                <div class="logo-link" aria-hidden="true">
                  <img
                    class="logo-img"
                    src="{{ img | image_url: width: 600 }}"
                    srcset="
                      {{ img | image_url: width: 200 }} 200w,
                      {{ img | image_url: width: 300 }} 300w,
                      {{ img | image_url: width: 600 }} 600w
                    "
                    sizes="(min-width: 990px) calc((100vw - 2*var(--page-padding)) / var(--per-desktop)),
                           (min-width: 750px) calc((100vw - 2*var(--page-padding)) / var(--per-tablet)),
                           calc((100vw - 2*var(--page-padding)) / var(--per-mobile))"
                    alt="{{ block.settings.alt_text | default: img.alt | escape }}"
                    loading="lazy"
                  />
                </div>
              {% endif %}

                {% if section.settings.show_titles and item_title != blank and title_pos == 'below' %}
                <div class="logo-title">{{ item_title }}</div>
                {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <button class="nav-btn next" aria-label="Next" type="button">
        <span aria-hidden="true">›</span>
      </button>

      {% if section.settings.show_dots and section.blocks.size > 1 %}
        <div class="logo-carousel-dots" aria-label="Carousel pagination" role="tablist"></div>
      {% endif %}
    </div>
  </div>

  <style>
    #logo-carousel-{{ section.id }} {
      background: var(--bg);
      padding-top: var(--pt);
      padding-bottom: var(--pb);
    }
    #logo-carousel-{{ section.id }} .logo-carousel-container {
      max-width: {{ settings.page_width | default: 1200 }}px;
      margin: 0 auto;
      padding: 0 var(--page-padding, 20px);
    }
    #logo-carousel-{{ section.id }} .logo-carousel-heading {
      margin: 0 0 16px;
      font-size: clamp(18px, 2.2vw, 28px);
      font-weight: 600;
    }
/* Ensure the wrap has two rows: row 1 = prev/track/next, row 2 = dots */
#logo-carousel-{{ section.id }} .logo-carousel-track-wrap {
  display: grid;
  grid-template-columns: auto 1fr auto;
  grid-template-rows: auto auto;
  align-items: center;
  gap: 8px;
}
    #logo-carousel-{{ section.id }} .nav-btn.prev,
    #logo-carousel-{{ section.id }} .logo-carousel-track,
    #logo-carousel-{{ section.id }} .nav-btn.next { 
        grid-row: 1;
    }
    #logo-carousel-{{ section.id }} .nav-btn {
      appearance: none;
      border: 1px solid rgba(0,0,0,.1);
      background: white;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      cursor: pointer;
    }
    #logo-carousel-{{ section.id }} .nav-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.08); }

    #logo-carousel-{{ section.id }} .logo-carousel-track {
      overflow: hidden;
      display: flex;
      gap: var(--gap);
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      padding: 8px 2px; /* avoid edge clipping */
    }
    #logo-carousel-{{ section.id }} .logo-item {
      flex: 0 0 calc((100% - (var(--gap) * (var(--per-current) - 1))) / var(--per-current));
      scroll-snap-align: start;
      display: grid;
      justify-items: center;
      text-align: center;
      gap: 8px;
    }
    #logo-carousel-{{ section.id }} .logo-link { display: inline-block; }
    #logo-carousel-{{ section.id }} .logo-img {
      display: block;
      max-height: 90px;
      width: auto;
      height: auto;
      object-fit: contain;
      filter: var(--logo-filter, none);
    }
    #logo-carousel-{{ section.id }} .logo-title {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Center the dots container and the dots inside it */
    #logo-carousel-{{ section.id }} .logo-carousel-dots {
    grid-column: 1 / -1;   /* span full width */
    grid-row: 2;           /* second row */
    display: flex;         /* let us center the children */
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    width: 100%;
    place-self: center;    /* center the container itself in the grid */
    }
    #logo-carousel-{{ section.id }} .logo-carousel-dot {
    width: 8px; height: 8px; border-radius: 999px;
    border: 1px solid color-mix(in oklab, var(--dot-color), black 35%);
    background: color-mix(in oklab, var(--dot-color), white 80%);
    cursor: pointer;
    padding: 0;
    }
    #logo-carousel-{{ section.id }} .logo-carousel-dot[aria-selected="true"] {
    background: var(--dot-active-color);
    border-color: color-mix(in oklab, var(--dot-active-color), black 25%);
    } 

    /* Responsive items-per-view via CSS variable */
    #logo-carousel-{{ section.id }} .logo-carousel-track { --per-current: var(--per-desktop); }
    @media (max-width: 989px) {
      #logo-carousel-{{ section.id }} .logo-carousel-track { --per-current: var(--per-tablet); }
    }
    @media (max-width: 749px) {
      #logo-carousel-{{ section.id }} .logo-carousel-track { --per-current: var(--per-mobile); }
    }

    /* Hide nav on very small lists */
    {% if section.blocks.size <= 1 %}
      #logo-carousel-{{ section.id }} .nav-btn { display: none; }
    {% endif %}
  </style>

<script>
(function () {
  const root = document.getElementById('logo-carousel-{{ section.id }}');
  if (!root) return;

  const wrap    = root.querySelector('.logo-carousel-track-wrap');
  const track   = root.querySelector('.logo-carousel-track');
  const prevBtn = root.querySelector('.nav-btn.prev');
  const nextBtn = root.querySelector('.nav-btn.next');
  const dotsWrap = root.querySelector('.logo-carousel-dots');
  if (!track) return;

  // Loop cloning (once)
  const enableLoop = track.dataset.loop === 'true';
  if (enableLoop) {
    const clones = Array.from(track.children).map(n => n.cloneNode(true));
    clones.forEach(c => track.appendChild(c));
  }

  const originalCount = {{ section.blocks.size }};
  const respectRM = {{ section.settings.respect_reduced_motion | json }};
  const prefersRM = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const autoplaySetting = track.dataset.autoplay === 'true';
  const autoplay = autoplaySetting && !(respectRM && prefersRM);

  function itemWidth() {
    const first = track.querySelector('.logo-item');
    if (!first) return 0;
    return first.getBoundingClientRect().width + parseFloat(getComputedStyle(track).gap || 0);
  }

  function scrollByItems(count) {
    track.scrollBy({ left: count * itemWidth(), behavior: 'smooth' });
  }

  prevBtn?.addEventListener('click', () => scrollByItems(-1));
  nextBtn?.addEventListener('click', () => scrollByItems(1));

  // Autoplay
  let timer = null;
  const interval = parseInt(getComputedStyle(root).getPropertyValue('--auto-interval'), 10) || 2500;

  function start() {
    if (!autoplay) return;
    stop();
    timer = setInterval(() => {
      const nearEnd = (track.scrollWidth - track.clientWidth) - track.scrollLeft < itemWidth() * 1.5;
      if (nearEnd) {
        track.scrollTo({ left: 0, behavior: 'instant' in track ? 'instant' : 'auto' });
      } else {
        scrollByItems(1);
      }
    }, interval);
  }
  function stop() { if (timer) { clearInterval(timer); timer = null; } }

  track.addEventListener('mouseenter', stop);
  track.addEventListener('mouseleave', start);
  track.addEventListener('focusin', stop);
  track.addEventListener('focusout', start);

  // Keyboard
  track.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') { e.preventDefault(); scrollByItems(1); }
    if (e.key === 'ArrowLeft')  { e.preventDefault(); scrollByItems(-1); }
  });

  // Pagination dots
  function makeDots() {
    if (!dotsWrap || originalCount < 2) return;
    dotsWrap.innerHTML = '';
    for (let i = 0; i < originalCount; i++) {
      const b = document.createElement('button');
      b.className = 'logo-carousel-dot';
      b.type = 'button';
      b.setAttribute('role','tab');
      b.setAttribute('aria-label', `Go to slide ${i+1}`);
      b.addEventListener('click', () => {
        track.scrollTo({ left: i * itemWidth(), behavior: 'smooth' });
      });
      dotsWrap.appendChild(b);
    }
  }

  function syncDots() {
    if (!dotsWrap) return;
    const iw = itemWidth();
    if (!iw) return;
    const index = Math.round(track.scrollLeft / iw) % originalCount;
    Array.from(dotsWrap.children).forEach((d, i) => {
      d.setAttribute('aria-selected', i === index ? 'true' : 'false');
    });
  }

  makeDots();
  track.addEventListener('scroll', () => { requestAnimationFrame(syncDots); });
  window.addEventListener('resize', () => { requestAnimationFrame(syncDots); });
  syncDots();

  // Resize guard (vars handle most of it)
  let rAF;
  window.addEventListener('resize', () => {
    cancelAnimationFrame(rAF);
    rAF = requestAnimationFrame(() => {});
  });

  start();
  document.addEventListener('shopify:section:load', start);
  document.addEventListener('shopify:section:unload', stop);
})();
</script>

</section>

{% schema %}
{
  "name": "Logo Carousel",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Trusted by leading brands" },

    { "type": "header", "content": "Behavior" },
    { "type": "checkbox", "id": "autoplay", "label": "Auto scroll", "default": true },
    { "type": "range", "id": "auto_interval", "label": "Auto scroll speed (ms)", "min": 1200, "max": 6000, "step": 100, "default": 2500 },

    { "type": "header", "content": "Logos per view" },
    { "type": "range", "id": "per_desktop", "label": "Desktop (≥ 990px)", "min": 2, "max": 10, "step": 1, "default": 6 },
    { "type": "range", "id": "per_tablet",  "label": "Tablet (750–989px)", "min": 2, "max": 8, "step": 1, "default": 4 },
    { "type": "range", "id": "per_mobile",  "label": "Mobile (≤ 749px)",   "min": 1, "max": 6, "step": 1, "default": 2 },

    { "type": "checkbox", "id": "show_dots", "label": "Show pagination dots", "default": true },
    { "type": "color", "id": "dot_color", "label": "Pagination color", "default": "#666666" },
    { "type": "color", "id": "dot_active_color", "label": "Pagination active color", "default": "#000000" },


    { "type": "checkbox", "id": "show_titles", "label": "Show logo titles", "default": true },
    { "type": "checkbox", "id": "respect_reduced_motion", "label": "Respect reduced motion", "info": "Disable auto-scroll if the user prefers reduced motion", "default": true },

    { "type": "header", "content": "Link behavior" },
    { "type": "radio", "id": "link_target", "label": "Open logo links in", "default": "new",
      "options": [
        { "value": "same", "label": "Same tab" },
        { "value": "new",  "label": "New tab" }
      ]
    },

    { "type": "header", "content": "Spacing & background" },
    { "type": "range", "id": "space_top", "label": "Top spacing (px)", "min": 0, "max": 120, "step": 4, "default": 40 },
    { "type": "range", "id": "space_bottom", "label": "Bottom spacing (px)", "min": 0, "max": 120, "step": 4, "default": 40 },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#FFFFFF" }
  ],
  "blocks": [
    {
      "type": "logo",
      "name": "Logo",
      "settings": [
        { "type": "image_picker", "id": "logo", "label": "Logo image" },
        { "type": "text", "id": "alt_text", "label": "Alt text (accessibility)" },
        { "type": "url", "id": "link", "label": "Optional link" },
        { "type": "text", "id": "logo_title", "label": "Optional title" },
        {
          "type": "select",
          "id": "title_position",
          "label": "Title position",
          "default": "below",
          "options": [
            { "value": "above", "label": "Above logo" },
            { "value": "below", "label": "Below logo" }
          ]
        }
      ]
    }
  ],
  "presets": [
    { "name": "Logo Carousel", "category": "Image" }
  ]
}
{% endschema %}

{% stylesheet %}
  /* Reserved for themes that concatenate section CSS */
{% endstylesheet %}

{% javascript %}
  /* Reserved for themes that concatenate section JS */
{% endjavascript %}
