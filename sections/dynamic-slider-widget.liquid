{% comment %}
  Dynamic Slider Widget — OS 2.0
  Features:
  - Multiple slides (image OR solid-color), title, subtitle, CTA per slide
  - Heights per breakpoint (px), overlay color + opacity
  - Autoplay toggle, interval timing, transition effect (slide / fade), duration
  - Per-slide text/CTA colors
  Notes:
  - Range fields use step logic that ensures >=101 steps (Shopify validator quirk)
{% endcomment %}

<section
  id="dyn-slider-{{ section.id }}"
  class="dyn-slider"
  data-effect="{{ section.settings.effect }}"
  data-autoplay="{{ section.settings.autoplay }}"
  data-interval="{{ section.settings.interval_ms }}"
  data-duration="{{ section.settings.duration_ms }}"
  style="
    --ds-overlay: {{ section.settings.overlay_color }};
    --ds-overlay-op: {{ section.settings.overlay_opacity | times: 0.01 }};
    /* Heights (responsive) */
    --ds-h-desktop: {{ section.settings.h_desktop_pct | times: 6   | plus: 240 | round: 0 }}px;
    --ds-h-tablet:  {{ section.settings.h_tablet_pct  | times: 4.8 | plus: 240 | round: 0 }}px;
    --ds-h-mobile:  {{ section.settings.h_mobile_pct  | times: 4   | plus: 180 | round: 0 }}px;
  "
>
  <div class="ds-viewport" aria-live="polite">
    <div class="ds-track">
      {% for block in section.blocks %}
        {% if block.type == 'slide' %}
          {% assign has_img = false %}
          {% if block.settings.image != blank %}
            {% assign has_img = true %}
          {% endif %}
          <article class="ds-slide{% if forloop.first %} is-active{% endif %}" {{ block.shopify_attributes }} data-pos="{{ block.settings.content_pos }}"
            style="
              --t-color: {{ block.settings.title_color }};
              --st-color: {{ block.settings.subtitle_color }};
              --cta-bg: {{ block.settings.btn_bg }};
              --cta-text: {{ block.settings.btn_text }};
              --solid-bg: {{ block.settings.solid_bg }};
            "
          >
        <div class="ds-bg" {% unless has_img %}style="background: {{ block.settings.solid_bg }};"{% endunless %}>
        {% if has_img %}
            {%- assign img = block.settings.image -%}
            <img
            class="ds-bg-img"
            src="{{ img | image_url: width: 1600 }}"
            srcset="
                {{ img | image_url: width: 800 }} 800w,
                {{ img | image_url: width: 1200 }} 1200w,
                {{ img | image_url: width: 1600 }} 1600w
            "
            sizes="100vw"
            alt="{{ block.settings.title | escape }}"
            loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
            >
        {% endif %}
        <span class="ds-overlay" aria-hidden="true"></span>
        </div>

            <div class="ds-content">
              {% if block.settings.title != blank %}
                <h2 class="ds-title">{{ block.settings.title }}</h2>
              {% endif %}
              {% if block.settings.subtitle != blank %}
                <p class="ds-subtitle">{{ block.settings.subtitle }}</p>
              {% endif %}
              {% if block.settings.btn_label != blank and block.settings.btn_url != blank %}
                <a class="ds-btn" href="{{ block.settings.btn_url }}" {% if block.settings.btn_newtab %}target="_blank" rel="noopener"{% endif %}>
                  {{ block.settings.btn_label }}
                </a>
              {% endif %}
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Controls -->
    <button class="ds-arrow ds-prev" type="button" aria-label="Previous slide">‹</button>
    <button class="ds-arrow ds-next" type="button" aria-label="Next slide">›</button>

    <div class="ds-dots" role="tablist" aria-label="Slide pagination">
      {% for block in section.blocks %}
        {% if block.type == 'slide' %}
          <button class="ds-dot{% if forloop.first %} is-active{% endif %}" role="tab" aria-controls="">{{ forloop.index }}</button>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <style>
    /* Layout */
    #dyn-slider-{{ section.id }}{position:relative}
    #dyn-slider-{{ section.id }} .ds-viewport{position:relative; overflow:hidden}
    #dyn-slider-{{ section.id }} .ds-track{display:flex; width:100%; height:var(--ds-h-desktop); position:relative}

    /* Heights by breakpoint */
    @media (max-width: 990px){
      #dyn-slider-{{ section.id }} .ds-track{height:var(--ds-h-tablet);}
    }
    @media (max-width: 640px){
      #dyn-slider-{{ section.id }} .ds-track{height:var(--ds-h-mobile);}
    }

    /* Slides */
    #dyn-slider-{{ section.id }} .ds-slide{
      position:relative; flex:0 0 100%; width:100%; height:100%;
      display:grid; place-items:center; isolation:isolate;
      transition: opacity var(--dur, .6s) ease, transform var(--dur, .6s) ease;
      opacity:1;
    }
    /* background image / solid */
    #dyn-slider-{{ section.id }} .ds-bg{position:absolute; inset:0; z-index:0}
    #dyn-slider-{{ section.id }} .ds-bg-img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    #dyn-slider-{{ section.id }} .ds-bg{position:absolute; inset:0; z-index:0; background-position:center; background-size:cover;}
    #dyn-slider-{{ section.id }} .ds-overlay{position:absolute; inset:0; background:var(--ds-overlay); opacity:var(--ds-overlay-op);}

    /* Content */
    #dyn-slider-{{ section.id }} .ds-content{position:relative; z-index:1; text-align:center; padding:1rem; max-width:1100px}
    #dyn-slider-{{ section.id }} .ds-title{color:var(--t-color); font-weight:800; font-size:clamp(22px, 5vw, 56px); margin:0 0 .4rem;}
    #dyn-slider-{{ section.id }} .ds-subtitle{color:var(--st-color); font-size:clamp(14px, 3.2vw, 22px); margin:0 0 1rem;}
    #dyn-slider-{{ section.id }} .ds-btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      background:var(--cta-bg); color:var(--cta-text);
      padding:.75rem 1.25rem; border-radius:999px; text-decoration:none; font-weight:700;
      transition:filter .2s ease; border:2px solid transparent;
    }
    #dyn-slider-{{ section.id }} .ds-btn:hover{filter:brightness(.96)}

    /* Effect: slide */
    #dyn-slider-{{ section.id }}[data-effect="slide"] .ds-track{transform:translateX(var(--x, 0)); transition: transform var(--dur, .6s) ease;}
    /* Effect: fade */
    #dyn-slider-{{ section.id }}[data-effect="fade"] .ds-track{display:block}
    #dyn-slider-{{ section.id }}[data-effect="fade"] .ds-slide{position:absolute; inset:0; opacity:0}
    #dyn-slider-{{ section.id }}[data-effect="fade"] .ds-slide.is-active{opacity:1}

    /* Arrows */
    #dyn-slider-{{ section.id }} .ds-arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.45); color:#fff; border:0; width:40px; height:40px; border-radius:999px;
      display:grid; place-items:center; cursor:pointer; z-index:5;
    }
    #dyn-slider-{{ section.id }} .ds-prev{left:12px}
    #dyn-slider-{{ section.id }} .ds-next{right:12px}

    /* Default center */
    #dyn-slider-{{ section.id }} .ds-content{
    place-self: center;            /* align-self + justify-self */
    text-align: center;
    padding: 1rem;
    }

    /* Position variants */
    #dyn-slider-{{ section.id }} .ds-slide[data-pos="left-bottom"] .ds-content{
    place-self: end start;
    text-align: left;
    }
    #dyn-slider-{{ section.id }} .ds-slide[data-pos="right-bottom"] .ds-content{
    place-self: end end;
    text-align: right;
    }
    #dyn-slider-{{ section.id }} .ds-slide[data-pos="center-bottom"] .ds-content{
    place-self: end center;
    text-align: center;
    }
    #dyn-slider-{{ section.id }} .ds-slide[data-pos="left-center"] .ds-content{
    place-self: center start;
    text-align: left;
    }
    #dyn-slider-{{ section.id }} .ds-slide[data-pos="right-center"] .ds-content{
    place-self: center end;
    text-align: right;
    }

    /* Dots */
    #dyn-slider-{{ section.id }} .ds-dots{position:absolute; left:50%; transform:translateX(-50%); bottom:12px; display:flex; gap:8px; z-index:5}
    #dyn-slider-{{ section.id }} .ds-dot{
      width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.5); border:0; cursor:pointer; font-size: 0; cursor: pointer; padding: 0;
    }
    #dyn-slider-{{ section.id }} .ds-dot.is-active{background:#fff}
  </style>

  <script>
  (function(){
    var root = document.getElementById('dyn-slider-{{ section.id }}');
    if(!root) return;
    var track = root.querySelector('.ds-track');
    var slides = Array.prototype.slice.call(root.querySelectorAll('.ds-slide'));
    var prev = root.querySelector('.ds-prev');
    var next = root.querySelector('.ds-next');
    var dots = Array.prototype.slice.call(root.querySelectorAll('.ds-dot'));

    var effect = root.getAttribute('data-effect') || 'slide';
    var autoplay = root.getAttribute('data-autoplay') === 'true';
    var interval = parseInt(root.getAttribute('data-interval') || '5000', 10);
    var duration = parseInt(root.getAttribute('data-duration') || '600', 10);
    var i = 0, timer = null;

    function apply(){
      var pct = (-100 * i) + '%';
      track.style.setProperty('--dur', (duration/1000)+'s');
      if(effect === 'slide'){
        track.style.setProperty('--x', pct);
      }else{
        slides.forEach(function(s, idx){ s.classList.toggle('is-active', idx === i); });
      }
      dots.forEach(function(d, idx){ d.classList.toggle('is-active', idx === i); });
    }
    function go(n){
      var max = slides.length;
      i = (n + max) % max;
      apply();
    }
    function nextFn(){ go(i+1); }
    function prevFn(){ go(i-1); }

    if(prev) prev.addEventListener('click', prevFn);
    if(next) next.addEventListener('click', nextFn);
    dots.forEach(function(d, idx){ d.addEventListener('click', function(){ go(idx); }); });

    function start(){ if(autoplay){ stop(); timer = setInterval(nextFn, interval); } }
    function stop(){ if(timer){ clearInterval(timer); timer = null; } }

    root.addEventListener('mouseenter', stop);
    root.addEventListener('mouseleave', start);

    apply(); start();
  })();
  </script>
</section>

{% schema %}
{
  "name": "Dynamic slider widget",
  "settings": [
    { "type": "range", "id": "h_desktop_pct", "label": "Slider height desktop (0–100 → 240–840px)", "min": 0, "max": 100, "step": 1, "default": 50, "unit": "%" },
    { "type": "range", "id": "h_tablet_pct",  "label": "Slider height tablet (0–100 → 240–720px)",  "min": 0, "max": 100, "step": 1, "default": 50, "unit": "%" },
    { "type": "range", "id": "h_mobile_pct",  "label": "Slider height mobile (0–100 → 180–580px)",  "min": 0, "max": 100, "step": 1, "default": 45, "unit": "%" },

    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity (%)", "min": 0, "max": 100, "step": 1, "default": 40 },

    { "type": "select", "id": "effect", "label": "Transition effect", "options": [
      { "value": "slide", "label": "Slide" },
      { "value": "fade", "label": "Fade" }
    ], "default": "slide" },

    { "type": "checkbox", "id": "autoplay", "label": "Auto slide", "default": true },

    { "type": "range", "id": "interval_pct", "label": "Interval (0–100 → 1000–20000 ms)", "min": 0, "max": 100, "step": 1, "default": 21, "unit": "%" },

    { "type": "range", "id": "duration_ms", "label": "Transition duration (ms)", "min": 200, "max": 2000, "step": 18, "default": 596 }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Background image (optional)" },
        { "type": "color", "id": "solid_bg", "label": "Solid background (used when no image)", "default": "#111827" },

        { "type": "text", "id": "title", "label": "Title", "default": "Slide title" },
        { "type": "textarea", "id": "subtitle", "label": "Subtitle", "default": "Your supporting subtitle text goes here." },

        { "type": "color", "id": "title_color", "label": "Title color", "default": "#ffffff" },
        { "type": "color", "id": "subtitle_color", "label": "Subtitle color", "default": "#e5e7eb" },

        { "type": "text", "id": "btn_label", "label": "Button label", "default": "Shop now" },
        { "type": "url", "id": "btn_url", "label": "Button link" },
        { "type": "checkbox", "id": "btn_newtab", "label": "Open button in new tab", "default": false },
        { "type": "color", "id": "btn_bg", "label": "Button background", "default": "#ffffff" },
        { "type": "color", "id": "btn_text", "label": "Button text color", "default": "#111827" },

        { "type": "select", "id": "content_pos", "label": "Content position", "options": [
          { "value": "center-center", "label": "Center / Center" },
          { "value": "left-bottom",  "label": "Left / Bottom" },
          { "value": "right-bottom", "label": "Right / Bottom" },
          { "value": "center-bottom","label": "Center / Bottom" },
          { "value": "left-center",  "label": "Left / Center" },
          { "value": "right-center", "label": "Right / Center" }
        ], "default": "center-center" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Dynamic slider widget",
      "blocks": [
        { "type": "slide", "settings": { "title": "Feel better today", "subtitle": "Ergonomic comfort for long sitting hours", "btn_label": "Explore", "btn_url": "#", "content_pos": "center-center" } },
        { "type": "slide", "settings": { "title": "Support that lasts", "subtitle": "Premium materials, premium relief", "btn_label": "Buy now", "btn_url": "#", "content_pos": "left-bottom" } },
        { "type": "slide", "settings": { "title": "Loved by thousands", "subtitle": "Backed by 5-star reviews", "btn_label": "See reviews", "btn_url": "#", "content_pos": "right-bottom" } }
      ]
    }
  ]
}
{% endschema %}
